<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Cargo Acceptance & Receiving Form</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --red-main:#c62828;
  --red-soft:#f6eaea;
  --border-soft:#ddd;
  --success:#2e7d32;
  --warning:#f57c00;
}
*{box-sizing:border-box;}
body{margin:0;padding:0;background:#f2f2f2;font-family:Arial,sans-serif;color:#000;}
.form-container{
  max-width:1200px;
  margin:0 auto;
  padding:10px 15px;
  background:#fff;
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 8px 25px rgba(0,0,0,0.08);
}

/* HEADER */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  padding:15px 20px;
  background:#fff;
  border-bottom:4px solid var(--red-main);
}
.logo img{
  max-width:100%; max-height:60px; object-fit:contain;
}
.header-text{flex:1;text-align:right;}
.header-text h2{margin:0;color:var(--red-main);font-size:20px;}
.header-text p{margin:5px 0 0;opacity:0.9;text-align:right;font-size:12px;}

/* Language Switcher */
.lang-switcher{
  position:absolute;
  top:15px;
  right:15px;
  background:#fff;
  border:1px solid var(--border-soft);
  border-radius:8px;
  padding:5px;
  display:flex;
  gap:5px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
  z-index:100;
}
.lang-btn{
  padding:8px 15px;
  border:none;
  background:transparent;
  cursor:pointer;
  border-radius:6px;
  font-weight:bold;
  transition:0.3s;
  font-size:13px;
}
.lang-btn.active{background:var(--red-main);color:#fff;}
.lang-btn:hover:not(.active){background:#f5f5f5;}

/* Progress Bar */
.progress-container{
  padding:15px 20px;
  background:#f9f9f9;
  border-radius:8px;
  margin:15px 0;
}
.progress-label{
  display:flex;
  justify-content:space-between;
  font-size:12px;
  font-weight:bold;
  margin-bottom:8px;
  color:#555;
}
.progress-bar-bg{
  width:100%;
  height:20px;
  background:#e0e0e0;
  border-radius:10px;
  overflow:hidden;
  position:relative;
}
.progress-bar-fill{
  height:100%;
  background:linear-gradient(90deg, var(--red-main), #e53935);
  border-radius:10px;
  transition:width 0.4s ease;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-size:11px;
  font-weight:bold;
}

/* Auto-save Indicator */
.autosave-indicator{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 15px;
  background:#f9f9f9;
  border-radius:8px;
  margin:10px 0;
  font-size:12px;
  border:1px solid var(--border-soft);
}
.autosave-indicator i{color:var(--success);}
.autosave-text{color:#666;}
.restore-data-btn{
  margin-left:auto;
  padding:6px 12px;
  background:var(--red-main);
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:11px;
  transition:0.3s;
}
.restore-data-btn:hover{background:#a01f1f;}

/* Sections */
.section{padding:20px;border-bottom:1px solid var(--border-soft); page-break-inside:avoid;}
.section.completed .section-title{background:var(--success);}
.section.completed.print-mode .section-title{background:var(--red-main) !important;}
.section-title{
  display:flex;
  align-items:center;
  gap:10px;
  width:100%;
  padding:12px 20px;
  font-weight:bold;
  color:#fff;
  background-color:var(--red-main);
  border-radius:12px;
  margin-bottom:15px;
  font-size:14px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
.section-title i{font-size:16px;}
.note{font-size:12px;color:#666;margin:10px 0;}

/* Reference Number (PDF only) */
.reference-number{
  text-align:right;
  padding:10px 20px;
  font-size:12px;
  color:#666;
  border-bottom:1px solid var(--border-soft);
}
.reference-number strong{color:var(--red-main);}

/* Grid */
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:15px;}
.col-1{grid-column:span 1}.col-2{grid-column:span 2}.col-3{grid-column:span 3}
.col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-6{grid-column:span 6}
.col-8{grid-column:span 8}.col-12{grid-column:span 12}

/* Fields */
.field-wrapper{position:relative;}
label{font-size:12px;font-weight:bold;display:flex;align-items:center;gap:6px;}
label i{color:var(--red-main);font-size:14px;}
input,select,textarea{
  width:100%;
  padding:10px 12px;
  margin-top:6px;
  border:1px solid var(--border-soft);
  border-radius:6px;
  transition:.2s;
  font-size:13px;
}
input::placeholder, textarea::placeholder{color:#aaa;font-size:12px;}
textarea{resize:vertical;min-height:80px;}
input.filled,select.filled,textarea.filled{background:var(--red-soft);border-color:var(--red-main);}
.error-msg{color:#c62828;font-size:11px;margin-top:4px;display:none;}

/* File Upload */
.file-upload-wrapper{position:relative;margin-top:6px;}
.file-upload-btn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 16px;
  background:#f5f5f5;
  border:2px dashed var(--border-soft);
  border-radius:8px;
  cursor:pointer;
  transition:0.3s;
  font-size:12px;
  color:#666;
}
.file-upload-btn:hover{border-color:var(--red-main);background:var(--red-soft);}
.file-upload-btn i{color:var(--red-main);}
.file-input{display:none;}
.file-preview{
  margin-top:8px;
  padding:10px;
  background:#f9f9f9;
  border-radius:6px;
  display:none;
  align-items:center;
  gap:10px;
  font-size:12px;
}
.file-preview.show{display:flex;}
.file-info{flex:1;display:flex;align-items:center;gap:8px;}
.file-icon{color:var(--red-main);font-size:18px;}
.file-name{font-weight:bold;color:#333;}
.file-size{color:#999;font-size:11px;}
.file-actions{display:flex;gap:8px;}
.file-btn{
  padding:6px 12px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-size:11px;
  transition:0.3s;
}
.preview-btn{background:var(--red-main);color:#fff;}
.preview-btn:hover{background:#a01f1f;}
.remove-btn{background:#f44336;color:#fff;}
.remove-btn:hover{background:#d32f2f;}

/* Signature */
.signature-wrapper{position:relative;}
.signature-box{
  border:2px solid var(--border-soft);
  border-radius:8px;
  height:160px;
  background:#fafafa;
  cursor:crosshair;
}
.signature-controls{
  display:flex;
  gap:8px;
  margin-top:8px;
}
.sig-btn{
  padding:8px 14px;
  border:none;
  background:#f5f5f5;
  cursor:pointer;
  border-radius:6px;
  font-size:11px;
  transition:0.3s;
  display:flex;
  align-items:center;
  gap:6px;
}
.sig-btn:hover{background:#e0e0e0;}
.sig-btn i{font-size:12px;}
.upload-sig-input{display:none;}

/* Buttons */
.submit-btn{
  width:100%;
  padding:16px;
  border:none;
  background:var(--red-main);
  color:#fff;
  font-size:14px;
  cursor:pointer;
  border-radius:8px;
  transition:.3s;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  font-weight:bold;
}
.submit-btn:hover:not(:disabled){background:#a01f1f;transform:translateY(-2px);box-shadow:0 4px 12px rgba(198,40,40,0.3);}
.submit-btn:disabled{opacity:0.6;cursor:not-allowed;}
.submit-btn.success{background:var(--success);}
.submit-btn.success:hover:not(:disabled){background:#1b5e20;}

/* Toast Notifications */
.toast{
  position:fixed;
  bottom:30px;
  right:30px;
  padding:16px 20px;
  background:#333;
  color:#fff;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
  display:none;
  align-items:center;
  gap:12px;
  z-index:1000;
  animation:slideIn 0.3s ease;
  max-width:350px;
}
.toast.show{display:flex;}
.toast.success{background:var(--success);}
.toast.error{background:#d32f2f;}
.toast.warning{background:var(--warning);}
.toast i{font-size:20px;}
.toast-message{flex:1;font-size:13px;}
@keyframes slideIn{
  from{transform:translateX(400px);opacity:0;}
  to{transform:translateX(0);opacity:1;}
}

/* Modal */
.modal{
  display:none;
  position:fixed;
  z-index:1000;
  left:0;
  top:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.6);
  animation:fadeIn 0.3s;
}
.modal.show{display:flex;align-items:center;justify-content:center;}
.modal-content{
  background:#fff;
  padding:30px;
  border-radius:12px;
  max-width:500px;
  width:90%;
  box-shadow:0 10px 40px rgba(0,0,0,0.3);
  animation:modalSlide 0.3s;
}
.modal-header{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:20px;
}
.modal-header i{font-size:32px;color:var(--red-main);}
.modal-header h3{margin:0;color:#333;}
.modal-body{margin:20px 0;color:#666;font-size:14px;line-height:1.6;}
.modal-footer{
  display:flex;
  gap:10px;
  justify-content:flex-end;
}
.modal-btn{
  padding:10px 20px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
  transition:0.3s;
  font-weight:bold;
}
.modal-btn.primary{background:var(--red-main);color:#fff;}
.modal-btn.primary:hover{background:#a01f1f;}
.modal-btn.secondary{background:#e0e0e0;color:#333;}
.modal-btn.secondary:hover{background:#d0d0d0;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
@keyframes modalSlide{from{transform:translateY(-50px);opacity:0;}to{transform:translateY(0);opacity:1;}}

/* Hide in PDF */
.hide-in-pdf{display:block;}
.show-in-pdf{display:none;}
@media print{
  .hide-in-pdf{display:none !important;}
  .show-in-pdf{display:block !important;}
  body{background:#fff !important;}
  .form-container{box-shadow:none !important;}
  .section.completed .section-title{background:var(--red-main) !important;}
}

/* Responsive */
@media(max-width:900px){
  .lang-switcher{position:relative;top:0;right:0;margin:10px 0;justify-content:center;}
  .header{flex-direction:column;align-items:center;text-align:center;}
  .header-text{text-align:center;margin-top:10px;}
  .col-1,.col-2,.col-3,.col-4,.col-5,.col-6,.col-8{grid-column:span 12 !important;}
  .toast{bottom:20px;right:20px;left:20px;max-width:none;}
}

/* RTL Support */
[dir="rtl"] .header-text{text-align:left;}
[dir="rtl"] label{flex-direction:row-reverse;}
[dir="rtl"] .section-title{flex-direction:row-reverse;}
[dir="rtl"] .progress-label{flex-direction:row-reverse;}
[dir="rtl"] .file-info{flex-direction:row-reverse;}
[dir="rtl"] .toast{right:auto;left:30px;}
[dir="rtl"] .lang-switcher{right:auto;left:15px;}
</style>
</head>

<body>
<div class="form-container">

<!-- Language Switcher -->
<div class="lang-switcher hide-in-pdf">
  <button class="lang-btn active" onclick="switchLanguage('en')">English</button>
  <button class="lang-btn" onclick="switchLanguage('ar')">العربية</button>
</div>

<!-- HEADER -->
<div class="header">
  <div class="logo">
    <img src="https://raw.githubusercontent.com/bfouad81/logo/refs/heads/main/New%20Bitmap%20image.bmp" alt="Company Logo" crossorigin="anonymous">
  </div>
  <div class="header-text">
    <h2 data-translate="title">Cargo Acceptance & Receiving Form</h2>
    <p data-translate="subtitle">Please fill all required fields marked with *</p>
  </div>
</div>

<!-- Reference Number (Show in PDF only) -->
<div class="reference-number show-in-pdf">
  <strong>Reference No:</strong> <span id="refNumber"></span>
</div>

<!-- Progress Bar -->
<div class="progress-container hide-in-pdf">
  <div class="progress-label">
    <span data-translate="progress">Form Completion</span>
    <span id="progressPercent">0%</span>
  </div>
  <div class="progress-bar-bg">
    <div class="progress-bar-fill" id="progressBar" style="width:0%">0%</div>
  </div>
</div>

<!-- Auto-save Indicator -->
<div class="autosave-indicator hide-in-pdf" id="autosaveIndicator" style="display:none;">
  <i class="fas fa-check-circle"></i>
  <span class="autosave-text" data-translate="autosaved">Last saved: <span id="lastSaveTime">Never</span></span>
  <button class="restore-data-btn" onclick="showRestoreModal()" data-translate="restore">Restore Data</button>
</div>

<!-- CUSTOMER -->
<div class="section" id="section-customer">
<div class="section-title"><i class="fas fa-user"></i><span data-translate="customer">Customer / Shipper</span></div>
<div class="row">
  <div class="col-4">
    <label><i class="fas fa-signature"></i><span data-translate="name">Name</span> *</label>
    <input id="customerName" placeholder="John Doe" data-translate-placeholder="namePlaceholder" required>
    <span class="error-msg" id="error-customerName" data-translate="requiredField">This field is required</span>
  </div>
  <div class="col-4">
    <label><i class="fas fa-phone"></i><span data-translate="phone">Phone</span> *</label>
    <input id="customerPhone" placeholder="+20 123 456 7890" data-translate-placeholder="phonePlaceholder" required>
    <span class="error-msg" id="error-customerPhone" data-translate="requiredField">This field is required</span>
  </div>
  <div class="col-4">
    <label><i class="fas fa-map-marker-alt"></i><span data-translate="address">Address</span> *</label>
    <input id="customerAddress" placeholder="123 Street Name, City" data-translate-placeholder="addressPlaceholder" required>
    <span class="error-msg" id="error-customerAddress" data-translate="requiredField">This field is required</span>
  </div>
  <div class="col-4">
    <label><i class="fas fa-envelope"></i><span data-translate="email">Email</span></label>
    <input id="customerEmail" type="email" placeholder="customer@email.com" data-translate-placeholder="emailPlaceholder">
  </div>
</div>
</div>

<!-- CONSIGNEE -->
<div class="section" id="section-consignee">
<div class="section-title"><i class="fas fa-shipping-fast"></i><span data-translate="consignee">Consignee / Receiver</span></div>
<div class="row">
  <div class="col-4">
    <label><i class="fas fa-signature"></i><span data-translate="name">Name</span> *</label>
    <input id="consigneeName" placeholder="Jane Smith" data-translate-placeholder="namePlaceholder" required>
    <span class="error-msg" id="error-consigneeName" data-translate="requiredField">This field is required</span>
  </div>
  <div class="col-4">
    <label><i class="fas fa-phone"></i><span data-translate="phone">Phone</span> *</label>
    <input id="consigneePhone" placeholder="+20 123 456 7890" data-translate-placeholder="phonePlaceholder" required>
    <span class="error-msg" id="error-consigneePhone" data-translate="requiredField">This field is required</span>
  </div>
  <div class="col-4">
    <label><i class="fas fa-map-marker-alt"></i><span data-translate="address">Address</span> *</label>
    <input id="consigneeAddress" placeholder="456 Street Name, City" data-translate-placeholder="addressPlaceholder" required>
    <span class="error-msg" id="error-consigneeAddress" data-translate="requiredField">This field is required</span>
  </div>
  <div class="col-4">
    <label><i class="fas fa-envelope"></i><span data-translate="email">Email</span></label>
    <input id="consigneeEmail" type="email" placeholder="receiver@email.com" data-translate-placeholder="emailPlaceholder">
  </div>
  <div class="col-4">
    <label><i class="fas fa-building"></i><span data-translate="company">Company Name</span></label>
    <input id="consigneeCompany" placeholder="Company Ltd." data-translate-placeholder="companyPlaceholder">
  </div>
</div>
</div>

<!-- SHIPMENT -->
<div class="section" id="section-shipment">
<div class="section-title"><i class="fas fa-truck"></i><span data-translate="shipment">Shipment Details</span></div>
<div class="row">
  <div class="col-6">
    <label><i class="fas fa-plane"></i><span data-translate="transport">Mode of Transport</span> *</label>
    <select id="transportMode" required>
      <option value="" data-translate="select">Select</option>
      <option data-translate="land">Land</option>
      <option data-translate="air">Air</option>
      <option data-translate="sea">Sea</option>
    </select>
    <span class="error-msg" id="error-transportMode" data-translate="requiredField">This field is required</span>
  </div>
  <div class="col-6">
    <label><i class="fas fa-box"></i><span data-translate="shipmentType">Shipment Type</span> *</label>
    <select id="shipmentType" required>
      <option value="" data-translate="select">Select</option>
      <option>LTL</option>
      <option>FTL</option>
      <option data-translate="courier">Courier</option>
      <option data-translate="other">Other</option>
    </select>
    <span class="error-msg" id="error-shipmentType" data-translate="requiredField">This field is required</span>
  </div>
</div>
</div>

<!-- CARGO -->
<div class="section" id="section-cargo">
<div class="section-title"><i class="fas fa-boxes"></i><span data-translate="cargo">Cargo Description</span></div>
<p class="note" data-translate="cargoNote">All information below is as declared by the shipper. Actual weight & CBM may differ.</p>
<div class="row">
  <div class="col-6">
    <label><i class="fas fa-clipboard"></i><span data-translate="description">Description</span> *</label>
    <input id="goodsDescription" placeholder="Electronics, Furniture, etc." data-translate-placeholder="descriptionPlaceholder" required>
    <span class="error-msg" id="error-goodsDescription" data-translate="requiredField">This field is required</span>
  </div>
  <div class="col-3">
    <label><i class="fas fa-archive"></i><span data-translate="packaging">Packaging</span> *</label>
    <select id="packagingType" required>
      <option value="" data-translate="select">Select</option>
      <option data-translate="box">Box</option>
      <option data-translate="pallet">Pallet</option>
      <option data-translate="crate">Wooden Crate</option>
      <option data-translate="drum">Drum</option>
      <option data-translate="bag">Bag</option>
    </select>
    <span class="error-msg" id="error-packagingType" data-translate="requiredField">This field is required</span>
  </div>
  <div class="col-1">
    <label><i class="fas fa-hashtag"></i><span data-translate="pkgs">Pkgs</span> *</label>
    <input id="packages" type="number" min="1" placeholder="5" required>
    <span class="error-msg" id="error-packages" data-translate="requiredField">Required</span>
  </div>
  <div class="col-1">
    <label><i class="fas fa-weight"></i><span data-translate="kg">KG</span> *</label>
    <input id="declaredWeight" type="number" min="0.1" step="0.1" placeholder="100.5" required>
    <span class="error-msg" id="error-declaredWeight" data-translate="requiredField">Required</span>
  </div>
  <div class="col-1">
    <label><i class="fas fa-cube"></i><span data-translate="cbm">CBM</span> *</label>
    <input id="cbm" type="number" min="0.01" step="0.01" placeholder="2.5" required>
    <span class="error-msg" id="error-cbm" data-translate="requiredField">Required</span>
  </div>
</div>
</div>

<!-- DOCUMENTS -->
<div class="section hide-in-pdf" id="section-documents">
  <div class="section-title"><i class="fas fa-file-upload"></i><span data-translate="documents">Documents Upload (Optional)</span></div>
  <p class="note" data-translate="fileLimit">Maximum file size: 5MB per file. Accepted formats: PDF, JPG, PNG</p>

  <div class="row">
    <div class="col-4">
      <label><i class="fas fa-file-invoice"></i><span data-translate="invoice">Invoice</span></label>
      <div class="file-upload-wrapper">
        <label class="file-upload-btn" for="invoiceFile">
          <i class="fas fa-cloud-upload-alt"></i>
          <span data-translate="chooseFile">Choose File</span>
        </label>
        <input type="file" id="invoiceFile" class="file-input" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileSelect(this, 'invoicePreview')">
      </div>
      <div id="invoicePreview" class="file-preview"></div>
    </div>

    <div class="col-4">
      <label><i class="fas fa-list-alt"></i><span data-translate="packingList">Packing List</span></label>
      <div class="file-upload-wrapper">
        <label class="file-upload-btn" for="packingListFile">
          <i class="fas fa-cloud-upload-alt"></i>
          <span data-translate="chooseFile">Choose File</span>
        </label>
        <input type="file" id="packingListFile" class="file-input" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileSelect(this, 'packingListPreview')">
      </div>
      <div id="packingListPreview" class="file-preview"></div>
    </div>

    <div class="col-4">
      <label><i class="fas fa-file-contract"></i><span data-translate="cmr">CMR / Waybill</span></label>
      <div class="file-upload-wrapper">
        <label class="file-upload-btn" for="cmrFile">
          <i class="fas fa-cloud-upload-alt"></i>
          <span data-translate="chooseFile">Choose File</span>
        </label>
        <input type="file" id="cmrFile" class="file-input" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileSelect(this, 'cmrPreview')">
      </div>
      <div id="cmrPreview" class="file-preview"></div>
    </div>

    <div class="col-4">
      <label><i class="fas fa-certificate"></i><span data-translate="origin">Certificate of Origin</span></label>
      <div class="file-upload-wrapper">
        <label class="file-upload-btn" for="originFile">
          <i class="fas fa-cloud-upload-alt"></i>
          <span data-translate="chooseFile">Choose File</span>
        </label>
        <input type="file" id="originFile" class="file-input" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileSelect(this, 'originPreview')">
      </div>
      <div id="originPreview" class="file-preview"></div>
    </div>

    <div class="col-4">
      <label><i class="fas fa-flask"></i><span data-translate="msds">MSDS</span></label>
      <div class="file-upload-wrapper">
        <label class="file-upload-btn" for="msdsFile">
          <i class="fas fa-cloud-upload-alt"></i>
          <span data-translate="chooseFile">Choose File</span>
        </label>
        <input type="file" id="msdsFile" class="file-input" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileSelect(this, 'msdsPreview')">
      </div>
      <div id="msdsPreview" class="file-preview"></div>
    </div>

    <div class="col-4">
      <label><i class="fas fa-file"></i><span data-translate="otherDoc">Other Document</span></label>
      <div class="file-upload-wrapper">
        <label class="file-upload-btn" for="otherFile">
          <i class="fas fa-cloud-upload-alt"></i>
          <span data-translate="chooseFile">Choose File</span>
        </label>
        <input type="file" id="otherFile" class="file-input" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileSelect(this, 'otherPreview')">
      </div>
      <div id="otherPreview" class="file-preview"></div>
    </div>
  </div>
</div>

<!-- SIGNATURE -->
<div class="section" id="section-signature">
<div class="section-title"><i class="fas fa-pen-fancy"></i><span data-translate="declaration">Declaration & Signatures</span></div>
<p class="note" data-translate="declarationText">
I hereby confirm that the above shipment has been handed over by the customer and
received by the logistics company in the stated condition and quantity for shipment
to the final destination.
</p>
<div class="row">
  <div class="col-6">
    <div class="signature-wrapper">
      <label><i class="fas fa-user-edit"></i><span data-translate="customerSig">Customer Signature</span></label>
      <canvas id="sigCustomer" class="signature-box"></canvas>
      <div class="signature-controls hide-in-pdf">
        <button class="sig-btn" onclick="sigCustomer.clear()"><i class="fas fa-eraser"></i><span data-translate="clear">Clear</span></button>
        <label class="sig-btn" for="uploadSigCustomer">
          <i class="fas fa-upload"></i><span data-translate="upload">Upload</span>
          <input type="file" id="uploadSigCustomer" class="upload-sig-input" accept="image/*" onchange="uploadSignature(this, sigCustomer)">
        </label>
      </div>
    </div>
  </div>
  <div class="col-6">
    <div class="signature-wrapper">
      <label><i class="fas fa-building"></i><span data-translate="companySig">Company Signature</span></label>
      <canvas id="sigCompany" class="signature-box"></canvas>
      <div class="signature-controls hide-in-pdf">
        <button class="sig-btn" onclick="sigCompany.clear()"><i class="fas fa-eraser"></i><span data-translate="clear">Clear</span></button>
        <label class="sig-btn" for="uploadSigCompany">
          <i class="fas fa-upload"></i><span data-translate="upload">Upload</span>
          <input type="file" id="uploadSigCompany" class="upload-sig-input" accept="image/*" onchange="uploadSignature(this, sigCompany)">
        </label>
      </div>
    </div>
  </div>
</div>
</div>

<!-- SAVE PDF BUTTON -->
<div class="section hide-in-pdf">
  <button type="button" id="savePdfBtn" class="submit-btn">
    <i class="fas fa-file-pdf"></i>
    <span data-translate="savePdf">Save as PDF</span>
  </button>
  <button type="button" id="sendEmailBtn" class="submit-btn success" style="margin-top:10px;">
    <i class="fas fa-paper-plane"></i>
    <span data-translate="sendEmail">Send Email</span>
  </button>
</div>

</div>

<!-- Toast Notification -->
<div id="toast" class="toast">
  <i class="fas fa-check-circle"></i>
  <div class="toast-message"></div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <i class="fas fa-exclamation-triangle"></i>
      <h3 data-translate="confirmTitle">Confirm Submission</h3>
    </div>
    <div class="modal-body" data-translate="confirmMessage">
      Are you sure you want to submit this form? An email will be sent with the form data.
    </div>
    <div class="modal-footer">
      <button class="modal-btn secondary" onclick="hideModal()" data-translate="cancel">Cancel</button>
      <button class="modal-btn primary" onclick="confirmSend()" data-translate="confirm">Confirm & Send</button>
    </div>
  </div>
</div>

<!-- Restore Data Modal -->
<div id="restoreModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <i class="fas fa-history"></i>
      <h3 data-translate="restoreTitle">Restore Saved Data</h3>
    </div>
    <div class="modal-body" data-translate="restoreMessage">
      We found saved data from your previous session. Would you like to restore it or start fresh?
    </div>
    <div class="modal-footer">
      <button class="modal-btn secondary" onclick="startFresh()" data-translate="startFresh">Start Fresh</button>
      <button class="modal-btn primary" onclick="restoreData()" data-translate="restoreData">Restore Data</button>
    </div>
  </div>
</div>

<script>
// ============= TRANSLATIONS =============
const translations = {
  en: {
    title: "Cargo Acceptance & Receiving Form",
    subtitle: "Please fill all required fields marked with *",
    progress: "Form Completion",
    autosaved: "Last saved:",
    restore: "Restore Data",
    customer: "Customer / Shipper",
    consignee: "Consignee / Receiver",
    shipment: "Shipment Details",
    cargo: "Cargo Description",
    documents: "Documents Upload (Optional)",
    history: "Recent Shipments",
    declaration: "Declaration & Signatures",
    name: "Name",
    phone: "Phone",
    address: "Address",
    email: "Email",
    company: "Company Name",
    transport: "Mode of Transport",
    shipmentType: "Shipment Type",
    description: "Description",
    packaging: "Packaging",
    pkgs: "Pkgs",
    kg: "KG",
    cbm: "CBM",
    invoice: "Invoice",
    packingList: "Packing List",
    cmr: "CMR / Waybill",
    origin: "Certificate of Origin",
    msds: "MSDS",
    otherDoc: "Other Document",
    customerSig: "Customer Signature",
    companySig: "Company Signature",
    savePdf: "Save as PDF",
    sendEmail: "Send Email",
    requiredField: "This field is required",
    select: "Select",
    land: "Land",
    air: "Air",
    sea: "Sea",
    courier: "Courier",
    other: "Other",
    box: "Box",
    pallet: "Pallet",
    crate: "Wooden Crate",
    drum: "Drum",
    bag: "Bag",
    chooseFile: "Choose File",
    clear: "Clear",
    upload: "Upload",
    cargoNote: "All information below is as declared by the shipper. Actual weight & CBM may differ.",
    fileLimit: "Maximum file size: 5MB per file. Accepted formats: PDF, JPG, PNG",
    declarationText: "I hereby confirm that the above shipment has been handed over by the customer and received by the logistics company in the stated condition and quantity for shipment to the final destination.",
    confirmTitle: "Confirm Submission",
    confirmMessage: "Are you sure you want to submit this form? An email will be sent with the form data.",
    cancel: "Cancel",
    confirm: "Confirm & Send",
    restoreTitle: "Restore Saved Data",
    restoreMessage: "We found saved data from your previous session. Would you like to restore it or start fresh?",
    startFresh: "Start Fresh",
    restoreData: "Restore Data",
    namePlaceholder: "John Doe",
    phonePlaceholder: "+20 123 456 7890",
    addressPlaceholder: "123 Street Name, City",
    emailPlaceholder: "email@example.com",
    companyPlaceholder: "Company Ltd.",
    descriptionPlaceholder: "Electronics, Furniture, etc."
  },
  ar: {
    title: "نموذج قبول واستلام الشحنات",
    subtitle: "يرجى ملء جميع الحقول المطلوبة المميزة بـ *",
    progress: "نسبة اكتمال النموذج",
    autosaved: "آخر حفظ:",
    restore: "استعادة البيانات",
    customer: "العميل / الشاحن",
    consignee: "المرسل إليه / المستلم",
    shipment: "تفاصيل الشحنة",
    cargo: "وصف البضاعة",
    documents: "رفع المستندات (اختياري)",
    history: "الشحنات الأخيرة",
    declaration: "الإقرار والتوقيعات",
    name: "الاسم",
    phone: "الهاتف",
    address: "العنوان",
    email: "البريد الإلكتروني",
    company: "اسم الشركة",
    transport: "وسيلة النقل",
    shipmentType: "نوع الشحنة",
    description: "الوصف",
    packaging: "التغليف",
    pkgs: "طرود",
    kg: "كجم",
    cbm: "متر مكعب",
    invoice: "الفاتورة",
    packingList: "قائمة التعبئة",
    cmr: "بوليصة الشحن",
    origin: "شهادة المنشأ",
    msds: "بيانات السلامة",
    otherDoc: "مستند آخر",
    customerSig: "توقيع العميل",
    companySig: "توقيع الشركة",
    savePdf: "حفظ كملف PDF",
    sendEmail: "إرسال بريد إلكتروني",
    requiredField: "هذا الحقل مطلوب",
    select: "اختر",
    land: "بري",
    air: "جوي",
    sea: "بحري",
    courier: "بريد سريع",
    other: "أخرى",
    box: "صندوق",
    pallet: "منصة نقالة",
    crate: "صندوق خشبي",
    drum: "برميل",
    bag: "كيس",
    chooseFile: "اختر ملف",
    clear: "مسح",
    upload: "رفع",
    cargoNote: "جميع المعلومات أدناه كما أقر بها الشاحن. قد يختلف الوزن والحجم الفعلي.",
    fileLimit: "الحد الأقصى لحجم الملف: 5 ميجابايت لكل ملف. الصيغ المقبولة: PDF، JPG، PNG",
    declarationText: "أقر بموجب هذا أن الشحنة المذكورة أعلاه قد تم تسليمها من قبل العميل واستلامها من قبل شركة الشحن في الحالة والكمية المذكورة للشحن إلى الوجهة النهائية.",
    confirmTitle: "تأكيد الإرسال",
    confirmMessage: "هل أنت متأكد من إرسال هذا النموذج؟ سيتم إرسال بريد إلكتروني مع بيانات النموذج.",
    cancel: "إلغاء",
    confirm: "تأكيد وإرسال",
    restoreTitle: "استعادة البيانات المحفوظة",
    restoreMessage: "وجدنا بيانات محفوظة من جلستك السابقة. هل تريد استعادتها أم البدء من جديد؟",
    startFresh: "بدء جديد",
    restoreData: "استعادة البيانات",
    namePlaceholder: "أحمد محمد",
    phonePlaceholder: "٠١٢٣٤٥٦٧٨٩٠",
    addressPlaceholder: "١٢٣ اسم الشارع، المدينة",
    emailPlaceholder: "email@example.com",
    companyPlaceholder: "شركة المثال المحدودة",
    descriptionPlaceholder: "إلكترونيات، أثاث، إلخ"
  }
};

let currentLang = 'en';

function switchLanguage(lang) {
  currentLang = lang;
  document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
  document.documentElement.lang = lang;
  
  // Update button states
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // Update all translatable elements
  document.querySelectorAll('[data-translate]').forEach(el => {
    const key = el.getAttribute('data-translate');
    if (translations[lang][key]) {
      el.textContent = translations[lang][key];
    }
  });
  
  // Update placeholders
  document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
    const key = el.getAttribute('data-translate-placeholder');
    if (translations[lang][key]) {
      el.placeholder = translations[lang][key];
    }
  });
  
  // Save language preference
  try {
    localStorage.setItem('preferredLanguage', lang);
  } catch(e) {}
}

// ============= SIGNATURE PADS =============
const sigCustomer = new SignaturePad(document.getElementById("sigCustomer"), {
  backgroundColor: 'rgb(250, 250, 250)'
});
const sigCompany = new SignaturePad(document.getElementById("sigCompany"), {
  backgroundColor: 'rgb(250, 250, 250)'
});

// Resize signatures on window resize
window.addEventListener('resize', () => {
  resizeCanvas(document.getElementById("sigCustomer"));
  resizeCanvas(document.getElementById("sigCompany"));
});

function resizeCanvas(canvas) {
  const ratio = Math.max(window.devicePixelRatio || 1, 1);
  canvas.width = canvas.offsetWidth * ratio;
  canvas.height = canvas.offsetHeight * ratio;
  canvas.getContext("2d").scale(ratio, ratio);
}

// Initialize canvas sizes
resizeCanvas(document.getElementById("sigCustomer"));
resizeCanvas(document.getElementById("sigCompany"));

// Upload signature from image
function uploadSignature(input, signaturePad) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        signaturePad.clear();
        const ctx = signaturePad.canvas.getContext('2d');
        const scale = Math.min(
          signaturePad.canvas.width / img.width,
          signaturePad.canvas.height / img.height
        );
        const x = (signaturePad.canvas.width / 2) - (img.width / 2) * scale;
        const y = (signaturePad.canvas.height / 2) - (img.height / 2) * scale;
        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);
  }
}

// ============= FILE HANDLING =============
const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
const uploadedFiles = {};

function handleFileSelect(input, previewId) {
  const file = input.files[0];
  const preview = document.getElementById(previewId);
  
  if (!file) {
    preview.classList.remove('show');
    delete uploadedFiles[input.id];
    return;
  }
  
  // Check file size
  if (file.size > MAX_FILE_SIZE) {
    showToast('error', currentLang === 'ar' ? 'حجم الملف كبير جداً! الحد الأقصى 5 ميجابايت' : 'File too large! Maximum 5MB');
    input.value = '';
    preview.classList.remove('show');
    return;
  }
  
  // Store file
  uploadedFiles[input.id] = file;
  
  // Show preview
  const fileName = file.name;
  const fileSize = (file.size / 1024).toFixed(2) + ' KB';
  const fileIcon = getFileIcon(file.type);
  
  preview.innerHTML = `
    <div class="file-info">
      <i class="${fileIcon} file-icon"></i>
      <div>
        <div class="file-name">${fileName}</div>
        <div class="file-size">${fileSize}</div>
      </div>
    </div>
    <div class="file-actions">
      <button class="file-btn remove-btn" onclick="removeFile('${input.id}', '${previewId}')">
        <i class="fas fa-times"></i> ${currentLang === 'ar' ? 'حذف' : 'Remove'}
      </button>
    </div>
  `;
  preview.classList.add('show');
  
  updateProgress();
  autoSave();
}

function getFileIcon(mimeType) {
  if (mimeType.includes('pdf')) return 'fas fa-file-pdf';
  if (mimeType.includes('image')) return 'fas fa-file-image';
  return 'fas fa-file';
}

function removeFile(inputId, previewId) {
  const input = document.getElementById(inputId);
  const preview = document.getElementById(previewId);
  
  input.value = '';
  preview.classList.remove('show');
  preview.innerHTML = '';
  delete uploadedFiles[inputId];
  
  updateProgress();
  autoSave();
}

async function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function getFileMimeType(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  const mimeTypes = {
    'pdf': 'application/pdf',
    'jpg': 'image/jpeg',
    'jpeg': 'image/jpeg',
    'png': 'image/png'
  };
  return mimeTypes[ext] || 'application/octet-stream';
}

// ============= FORM VALIDATION =============
function validateForm() {
  let isValid = true;
  const requiredFields = [
    'customerName', 'customerPhone', 'customerAddress',
    'consigneeName', 'consigneePhone', 'consigneeAddress',
    'transportMode', 'shipmentType', 'goodsDescription',
    'packagingType', 'packages', 'declaredWeight', 'cbm'
  ];
  
  document.querySelectorAll('.error-msg').forEach(el => el.style.display = 'none');
  
  requiredFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    const error = document.getElementById('error-' + fieldId);
    
    if (!field.value || field.value.trim() === '') {
      isValid = false;
      if (error) error.style.display = 'block';
      field.style.borderColor = '#c62828';
    } else {
      field.style.borderColor = '';
    }
  });
  
  if (!isValid) {
    showToast('error', currentLang === 'ar' ? 'يرجى ملء جميع الحقول المطلوبة' : 'Please fill in all required fields marked with *');
    
    // Focus on first error
    const firstError = document.querySelector('.error-msg[style*="block"]');
    if (firstError) {
      const field = document.getElementById(firstError.id.replace('error-', ''));
      if (field) {
        field.focus();
        field.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }
  
  return isValid;
}

// ============= PROGRESS BAR =============
function updateProgress() {
  const allFields = document.querySelectorAll('input[required], select[required]');
  const filledFields = Array.from(allFields).filter(field => field.value && field.value.trim() !== '');
  
  const progress = Math.round((filledFields.length / allFields.length) * 100);
  
  const progressBar = document.getElementById('progressBar');
  const progressPercent = document.getElementById('progressPercent');
  
  progressBar.style.width = progress + '%';
  progressBar.textContent = progress + '%';
  progressPercent.textContent = progress + '%';
  
  // Update section completion
  updateSectionCompletion('section-customer', ['customerName', 'customerPhone', 'customerAddress']);
  updateSectionCompletion('section-consignee', ['consigneeName', 'consigneePhone', 'consigneeAddress']);
  updateSectionCompletion('section-shipment', ['transportMode', 'shipmentType']);
  updateSectionCompletion('section-cargo', ['goodsDescription', 'packagingType', 'packages', 'declaredWeight', 'cbm']);
}

function updateSectionCompletion(sectionId, fieldIds) {
  const section = document.getElementById(sectionId);
  if (!section) return;
  
  const allFilled = fieldIds.every(id => {
    const field = document.getElementById(id);
    return field && field.value && field.value.trim() !== '';
  });
  
  if (allFilled) {
    section.classList.add('completed');
  } else {
    section.classList.remove('completed');
  }
}

// ============= AUTO-SAVE =============
let saveTimeout;
const SAVE_DELAY = 2000; // 2 seconds debounce

function autoSave() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => {
    saveFormData();
  }, SAVE_DELAY);
}

function saveFormData() {
  const saveData = { timestamp: new Date().toISOString() };
  
  document.querySelectorAll("input, select, textarea").forEach(el => {
    if (el.type !== 'file' && el.id) {
      saveData[el.id] = el.value;
    }
  });
  
  if (!sigCustomer.isEmpty()) {
    saveData.sigCustomer = sigCustomer.toDataURL();
  }
  if (!sigCompany.isEmpty()) {
    saveData.sigCompany = sigCompany.toDataURL();
  }
  
  try {
    localStorage.setItem('cargoFormData', JSON.stringify(saveData));
    
    // Update last save time
    const now = new Date();
    const timeStr = now.toLocaleTimeString(currentLang === 'ar' ? 'ar-EG' : 'en-US', {
      hour: '2-digit',
      minute: '2-digit'
    });
    document.getElementById('lastSaveTime').textContent = timeStr;
    document.getElementById('autosaveIndicator').style.display = 'flex';
    
  } catch (e) {
    console.error('Could not save:', e);
  }
}

function showRestoreModal() {
  document.getElementById('restoreModal').classList.add('show');
}

function restoreData() {
  try {
    const savedData = localStorage.getItem('cargoFormData');
    if (savedData) {
      const data = JSON.parse(savedData);
      
      Object.keys(data).forEach(key => {
        if (key === 'timestamp') return;
        
        if (key === 'sigCustomer' && data[key]) {
          sigCustomer.fromDataURL(data[key]);
        } else if (key === 'sigCompany' && data[key]) {
          sigCompany.fromDataURL(data[key]);
        } else {
          const el = document.getElementById(key);
          if (el && data[key]) {
            el.value = data[key];
            if (el.value) el.classList.add('filled');
          }
        }
      });
      
      updateProgress();
      showToast('success', currentLang === 'ar' ? 'تم استعادة البيانات بنجاح' : 'Data restored successfully');
    }
  } catch (e) {
    showToast('error', currentLang === 'ar' ? 'خطأ في استعادة البيانات' : 'Error restoring data');
  }
  
  hideModal();
}

function startFresh() {
  try {
    localStorage.removeItem('cargoFormData');
    document.getElementById('autosaveIndicator').style.display = 'none';
    showToast('success', currentLang === 'ar' ? 'تم البدء من جديد' : 'Started fresh');
  } catch (e) {}
  
  hideModal();
}

// ============= HISTORY =============
function loadHistory() {
  try {
    const history = JSON.parse(localStorage.getItem('shipmentHistory') || '[]');
    const historyList = document.getElementById('historyList');
    
    if (history.length === 0) {
      historyList.innerHTML = `<p class="note" style="text-align:center">${currentLang === 'ar' ? 'لا توجد شحنات سابقة' : 'No previous shipments'}</p>`;
      return;
    }
    
    historyList.innerHTML = history.slice(0, 5).map((item, index) => `
      <div style="padding:12px;background:#f9f9f9;border-radius:8px;margin-bottom:10px;cursor:pointer;border:1px solid var(--border-soft);transition:0.3s;" 
           onclick="copyFromHistory(${index})"
           onmouseover="this.style.borderColor='var(--red-main)'"
           onmouseout="this.style.borderColor='var(--border-soft)'">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <strong>${item.customerName}</strong> → <strong>${item.consigneeName}</strong>
            <div style="font-size:11px;color:#999;margin-top:4px;">
              ${item.packages} ${currentLang === 'ar' ? 'طرد' : 'packages'} | ${item.declaredWeight}KG | ${item.cbm}CBM
            </div>
          </div>
          <div style="font-size:11px;color:#999;">
            ${new Date(item.timestamp).toLocaleDateString(currentLang === 'ar' ? 'ar-EG' : 'en-US')}
          </div>
        </div>
      </div>
    `).join('');
  } catch (e) {}
}

function copyFromHistory(index) {
  try {
    const history = JSON.parse(localStorage.getItem('shipmentHistory') || '[]');
    const item = history[index];
    
    if (!item) return;
    
    // Copy main fields
    Object.keys(item).forEach(key => {
      if (key === 'timestamp' || key === 'refNumber') return;
      const el = document.getElementById(key);
      if (el) {
        el.value = item[key] || '';
        if (el.value) el.classList.add('filled');
      }
    });
    
    updateProgress();
    autoSave();
    showToast('success', currentLang === 'ar' ? 'تم نسخ البيانات' : 'Data copied from history');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } catch (e) {
    showToast('error', currentLang === 'ar' ? 'خطأ في النسخ' : 'Error copying data');
  }
}

function saveToHistory(formData) {
  try {
    const history = JSON.parse(localStorage.getItem('shipmentHistory') || '[]');
    history.unshift({
      ...formData,
      timestamp: new Date().toISOString()
    });
    
    // Keep only last 5
    if (history.length > 5) {
      history.length = 5;
    }
    
    localStorage.setItem('shipmentHistory', JSON.stringify(history));
  } catch (e) {}
}

// ============= TOAST NOTIFICATIONS =============
function showToast(type, message) {
  const toast = document.getElementById('toast');
  const toastMessage = toast.querySelector('.toast-message');
  const icon = toast.querySelector('i');
  
  toast.className = 'toast ' + type;
  toastMessage.textContent = message;
  
  // Update icon
  if (type === 'success') {
    icon.className = 'fas fa-check-circle';
  } else if (type === 'error') {
    icon.className = 'fas fa-exclamation-circle';
  } else if (type === 'warning') {
    icon.className = 'fas fa-exclamation-triangle';
  }
  
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 4000);
}

// ============= MODAL =============
function showModal() {
  document.getElementById('confirmModal').classList.add('show');
}

function hideModal() {
  document.querySelectorAll('.modal').forEach(modal => {
    modal.classList.remove('show');
  });
}

// ============= PDF GENERATION =============
function generateReferenceNumber() {
  const date = new Date();
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
  return `CGO-${year}${month}${day}-${random}`;
}

document.getElementById('savePdfBtn').addEventListener('click', async function() {
  if (!validateForm()) return;
  
  if (sigCustomer.isEmpty() || sigCompany.isEmpty()) {
    showToast('warning', currentLang === 'ar' ? 'يرجى إضافة كلا التوقيعين' : 'Please provide both signatures');
    return;
  }
  
  try {
    this.disabled = true;
    this.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${currentLang === 'ar' ? 'جاري الإنشاء...' : 'Generating...'}`;
    
    // Generate and show reference number
    const refNum = generateReferenceNumber();
    document.getElementById('refNumber').textContent = refNum;
    
    // Remove completed class from all sections (to avoid green color in PDF)
    document.querySelectorAll('.section').forEach(section => {
      section.classList.remove('completed');
    });
    
    // Hide elements
    document.querySelectorAll('.hide-in-pdf').forEach(el => {
      el.style.display = 'none';
    });
    
    // Show PDF-only elements
    document.querySelectorAll('.show-in-pdf').forEach(el => {
      el.style.display = 'block';
    });
    
    const element = document.querySelector('.form-container');
    const opt = {
      margin: 10,
      filename: `Cargo_Form_${refNum}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { 
        scale: 2, 
        scrollY: 0,
        useCORS: true,
        allowTaint: true
      },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all', 'css'] }
    };
    
    await html2pdf().set(opt).from(element).save();
    
    showToast('success', currentLang === 'ar' ? 'تم حفظ الملف بنجاح' : 'PDF saved successfully');
    
  } catch (error) {
    console.error('PDF Error:', error);
    showToast('error', currentLang === 'ar' ? 'خطأ في إنشاء الملف' : 'Error generating PDF');
  } finally {
    // Restore elements
    document.querySelectorAll('.hide-in-pdf').forEach(el => {
      el.style.display = '';
    });
    document.querySelectorAll('.show-in-pdf').forEach(el => {
      el.style.display = 'none';
    });
    
    // Restore completed classes
    updateProgress();
    
    this.disabled = false;
    this.innerHTML = `<i class="fas fa-file-pdf"></i> ${currentLang === 'ar' ? 'حفظ كملف PDF' : 'Save as PDF'}`;
  }
});

// ============= EMAIL SENDING =============
document.getElementById('sendEmailBtn').addEventListener('click', function() {
  if (!validateForm()) return;
  
  if (sigCustomer.isEmpty() || sigCompany.isEmpty()) {
    showToast('warning', currentLang === 'ar' ? 'يرجى إضافة كلا التوقيعين' : 'Please provide both signatures');
    return;
  }
  
  showModal();
});

async function confirmSend() {
  hideModal();
  
  const btn = document.getElementById('sendEmailBtn');
  
  try {
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${currentLang === 'ar' ? 'جاري التحويل...' : 'Converting...'}`;
    
    // Generate reference number
    const refNum = generateReferenceNumber();
    document.getElementById('refNumber').textContent = refNum;
    
    // Collect form data
    const formData = {
      refNumber: refNum,
      customerName: document.getElementById('customerName').value,
      customerPhone: document.getElementById('customerPhone').value,
      customerAddress: document.getElementById('customerAddress').value,
      customerEmail: document.getElementById('customerEmail').value,
      consigneeName: document.getElementById('consigneeName').value,
      consigneePhone: document.getElementById('consigneePhone').value,
      consigneeAddress: document.getElementById('consigneeAddress').value,
      consigneeEmail: document.getElementById('consigneeEmail').value,
      consigneeCompany: document.getElementById('consigneeCompany').value,
      transportMode: document.getElementById('transportMode').value,
      shipmentType: document.getElementById('shipmentType').value,
      goodsDescription: document.getElementById('goodsDescription').value,
      packagingType: document.getElementById('packagingType').value,
      packages: document.getElementById('packages').value,
      declaredWeight: document.getElementById('declaredWeight').value,
      cbm: document.getElementById('cbm').value,
      files: []
    };
    
    // Process files
    const fileInputs = ['invoiceFile', 'packingListFile', 'cmrFile', 'originFile', 'msdsFile', 'otherFile'];
    for (let id of fileInputs) {
      if (uploadedFiles[id]) {
        const file = uploadedFiles[id];
        const base64 = await fileToBase64(file);
        formData.files.push({
          name: file.name,
          data: base64,
          mimeType: getFileMimeType(file.name)
        });
      }
    }
    
    // Hide elements for PDF
    document.querySelectorAll('.hide-in-pdf').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.show-in-pdf').forEach(el => el.style.display = 'block');
    
    // Convert signatures to images for PDF
    const sigCustomerImg = document.createElement('img');
    const sigCompanyImg = document.createElement('img');
    sigCustomerImg.src = sigCustomer.toDataURL();
    sigCompanyImg.src = sigCompany.toDataURL();
    sigCustomerImg.style.width = '100%';
    sigCustomerImg.style.height = '160px';
    sigCustomerImg.style.border = '2px solid #ddd';
    sigCustomerImg.style.borderRadius = '8px';
    sigCompanyImg.style.width = '100%';
    sigCompanyImg.style.height = '160px';
    sigCompanyImg.style.border = '2px solid #ddd';
    sigCompanyImg.style.borderRadius = '8px';
    
    const sigCustomerCanvas = document.getElementById('sigCustomer');
    const sigCompanyCanvas = document.getElementById('sigCompany');
    const sigCustomerParent = sigCustomerCanvas.parentNode;
    const sigCompanyParent = sigCompanyCanvas.parentNode;
    
    sigCustomerCanvas.style.display = 'none';
    sigCompanyCanvas.style.display = 'none';
    sigCustomerParent.appendChild(sigCustomerImg);
    sigCompanyParent.appendChild(sigCompanyImg);
    
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${currentLang === 'ar' ? 'جاري إنشاء PDF...' : 'Creating PDF...'}`;
    
    // Generate PDF
    const element = document.querySelector('.form-container');
    const opt = {
      margin: [5, 5, 5, 5],
      filename: `Cargo_Form_${refNum}.pdf`,
      image: { type: 'jpeg', quality: 0.95 },
      html2canvas: { 
        scale: 2,
        useCORS: true,
        logging: false,
        letterRendering: true,
        scrollY: -window.scrollY,
        scrollX: 0,
        windowWidth: element.scrollWidth,
        windowHeight: element.scrollHeight
      },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };
    
    const pdf = await html2pdf().set(opt).from(element).outputPdf('dataurlstring');
    
    // Remove signature images and restore canvases
    document.querySelectorAll('#sigCustomer + img, #sigCompany + img').forEach(img => img.remove());
    sigCustomerCanvas.style.display = '';
    sigCompanyCanvas.style.display = '';
    
    // Restore elements
    document.querySelectorAll('.hide-in-pdf').forEach(el => el.style.display = '');
    document.querySelectorAll('.show-in-pdf').forEach(el => el.style.display = 'none');
    
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${currentLang === 'ar' ? 'جاري الإرسال...' : 'Sending...'}`;
    
    // Send to server
    const response = await fetch('https://script.google.com/macros/s/AKfycbwaTP8XvVnf4wVaY-HfRKyxn-z0piRvxf0waLfDGeuj6Vq7uSOj9AyNqZD7cHL5nFUl5Q/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        data: JSON.stringify(formData),
        pdfData: pdf,
        timestamp: new Date().getTime()
      })
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      showToast('success', currentLang === 'ar' ? 'تم إرسال النموذج بنجاح!' : 'Form submitted successfully!');
      
      // Clear form
      setTimeout(() => {
        document.querySelectorAll("input, select, textarea").forEach(el => {
          if (el.type === 'file') {
            el.value = '';
          } else if (el.type === 'checkbox' || el.type === 'radio') {
            el.checked = false;
          } else {
            el.value = '';
          }
          el.classList.remove('filled');
        });
        
        // Clear files
        Object.keys(uploadedFiles).forEach(key => delete uploadedFiles[key]);
        document.querySelectorAll('.file-preview').forEach(el => {
          el.classList.remove('show');
          el.innerHTML = '';
        });
        
        // Clear signatures
        sigCustomer.clear();
        sigCompany.clear();
        
        // Clear saved data
        try {
          localStorage.removeItem('cargoFormData');
          document.getElementById('autosaveIndicator').style.display = 'none';
        } catch(e) {}
        
        updateProgress();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }, 2000);
      
    } else {
      throw new Error(result.message || 'Unknown error');
    }
    
  } catch (error) {
    console.error('Send Error:', error);
    showToast('error', currentLang === 'ar' ? 'خطأ في الإرسال: ' + error.message : 'Error sending: ' + error.message);
    
    // Try to save data locally
    saveFormData();
    showToast('warning', currentLang === 'ar' ? 'تم حفظ البيانات محلياً' : 'Data saved locally');
    
  } finally {
    btn.disabled = false;
    btn.innerHTML = `<i class="fas fa-paper-plane"></i> ${currentLang === 'ar' ? 'إرسال بريد إلكتروني' : 'Send Email'}`;
  }
}

// ============= EVENT LISTENERS =============
document.querySelectorAll("input, select, textarea").forEach(el => {
  el.addEventListener("change", () => {
    if (el.value || el.files?.length) {
      el.classList.add("filled");
    } else {
      el.classList.remove("filled");
    }
    updateProgress();
    autoSave();
  });
  
  el.addEventListener("input", () => {
    const error = document.getElementById('error-' + el.id);
    if (error && el.value) {
      error.style.display = 'none';
      el.style.borderColor = '';
    }
    autoSave();
  });
});

// ============= INITIALIZATION =============
window.addEventListener('load', () => {
  // Load preferred language
  try {
    const savedLang = localStorage.getItem('preferredLanguage');
    if (savedLang && savedLang !== currentLang) {
      const btn = document.querySelector(`.lang-btn[onclick*="${savedLang}"]`);
      if (btn) btn.click();
    }
  } catch(e) {}
  
  // Check for saved data
  try {
    const savedData = localStorage.getItem('cargoFormData');
    if (savedData) {
      const data = JSON.parse(savedData);
      if (data.timestamp) {
        const savedDate = new Date(data.timestamp);
        const now = new Date();
        const diffHours = (now - savedDate) / (1000 * 60 * 60);
        
        // Show restore option if data is less than 7 days old
        if (diffHours < 168) {
          showRestoreModal();
        }
      }
    }
  } catch(e) {}
  
  // Initial progress update
  updateProgress();
});

// Close modals on outside click
window.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal')) {
    hideModal();
  }
});
</script>

</body>
</html>
